apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "appscope.fullname" . }}-webhook-cert-setup
  labels:
  {{- include "appscope.labels" . | nindent 4 }}
spec:
  backoffLimit: {{ .Values.webhookCertSetup.backoffLimit }}
  template:
    spec:
      containers:
      - args:
        - --service
        - {{ .Values.config.app }}
        - --webhook
        - {{ .Values.config.app }}.{{ .Values.config.namespace }}.appscope.io
        - --secret
        - scope-secret
        - --namespace
        - {{ .Values.config.namespace }}
        command:
        - ./generate_certificate.sh
        env:
        - name: KUBERNETES_CLUSTER_DOMAIN
          value: {{ quote .Values.kubernetesClusterDomain }}
        image: {{ .Values.webhookCertSetup.webhookCertSetup.image.repository }}:{{
          .Values.webhookCertSetup.webhookCertSetup.image.tag | default .Chart.AppVersion
          }}
        name: webhook-cert-setup
        resources: {}
      restartPolicy: OnFailure
      serviceAccountName: {{ include "appscope.fullname" . }}-webhook-cert-sa
