suite: Deployment
templates:
  - deployment.yaml
tests:
  - it: Should have health checks by default
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].readinessProbe
      - isNotNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: Should disable health checks
    set:
      config.probes: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: Should disable one health check
    set:
      config.readinessProbe: null
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe
      - isNotNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: Should customize health checks
    set:
      config:
        readinessProbe:
          httpGet:
            path: /isnt/a/real/endpoint
            port: 420
            scheme: HTTPS
          initialDelaySeconds: 5
          failureThreshold: 1
        livenessProbe:
          httpGet: null
          initialDelaySeconds: null
          failureThreshold: null
          foo: bar
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            httpGet:
              path: /isnt/a/real/endpoint
              port: 420
              scheme: HTTPS
            initialDelaySeconds: 5
            failureThreshold: 1
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            foo: bar

  - it: Should not have a strategy by default
    asserts:
      - isNull:
          path: spec.strategy
      - isNull:
          path: spec.updateStrategy

  - it: Should have a custom strategy
    set:
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1
          maxSurge: 1
    asserts:
      - isNotNull:
          path: spec.template.spec.strategy
      - isNull:
          path: spec.template.spec.updateStrategy
      - equal:
          path: spec.template.spec.strategy
          value:
            type: RollingUpdate
            rollingUpdate:
              maxUnavailable: 1
              maxSurge: 1

  - it: Should fail on bad strategy
    set:
      strategy:
        type: GOAT
    asserts:
      - failedTemplate:
          errorMessage: Not a valid strategy type for Deployment (GOAT)

  - it: Should set extraPodConfigs
    set:
      extraPodConfigs:
        foo:
          - goat: true
        topologySpreadConstraints:
          - goat: true
    asserts:
      - isNotNull:
          path: spec.template.spec.foo
      - isNotNull:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.foo
          value:
            - goat: true
      - equal:
          path: spec.template.spec.topologySpreadConstraints
          value:
            - goat: true

  - it: Should set tolerations
    set:
      tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    asserts:
      - isNotNull:
          path: spec.template.spec.tolerations
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: "key1"
              operator: "Equal"
              value: "value1"
              effect: "NoSchedule"